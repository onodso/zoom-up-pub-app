name: Weekly Code Review Request

on:
  schedule:
    - cron: '0 1 * * 1'  # æ¯é€±æœˆæ›œ10:00 JST (UTC+9)
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  request-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit info
        id: commit
        run: |
          echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
          echo "week=$(date +%V)" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: changes
        run: |
          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only HEAD~10 HEAD | head -20 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Review Issue
        uses: actions/github-script@v7
        with:
          script: |
            const week = '${{ steps.commit.outputs.week }}';
            const hash = '${{ steps.commit.outputs.hash }}';
            const message = '${{ steps.commit.outputs.message }}';
            const files = `${{ steps.changes.outputs.files }}`;
            
            const body = `
            ## ğŸ“‹ å®šæœŸãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ï¼ˆWeek ${week}ï¼‰
            
            **æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ**: \`${hash}\`  
            **å¤‰æ›´å†…å®¹**: ${message}
            
            ### ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
            
            - [ ] **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: è¨­è¨ˆæ›¸v2.2ã¨ã®æ•´åˆæ€§
            - [ ] **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ã€ã‚¯ã‚¨ãƒªæœ€é©åŒ–
            - [ ] **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: èªè¨¼ã€SQL Injectionå¯¾ç­–ã€XSSå¯¾ç­–
            - [ ] **UI/UX**: Red Dot Awardç´šã®å“è³ª
            - [ ] **ã‚³ãƒ¼ãƒ‰å“è³ª**: å¯èª­æ€§ã€ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
            - [ ] **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: DBåˆ¶ç´„ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
            
            ### ä¸»ãªå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«
            
            \`\`\`
            ${files}
            \`\`\`
            
            ### ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼
            
            @Claude-Opus @Claude-Sonnet @Gemini-Pro
            
            ---
            *è‡ªå‹•ç”Ÿæˆ: ${new Date().toISOString()}*
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ” Week ${week} Code Review`,
              body: body,
              labels: ['review', 'automated']
            });
